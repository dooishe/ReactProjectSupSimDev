<!DOCTYPE html>
<html>
  <head>
    <title>Chatbot</title>
    <link rel="stylesheet" href="./chatbot.css" />
    <link rel="stylesheet" href="./homework.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script src="https://unpkg.com/supersimpledev@8.6.4/dayjs.js"></script>
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>
    <script type="text/babel">
      function ChatInput({ setChatMessages, chatMessages }) {
        const [inputText, setInputText] = React.useState("");
        const [isLoading, setIsLoading] = React.useState(false);
        function saveInputText(event) {
          setInputText(event.target.value);
        }
        async function sendMessage() {
          if (isLoading || !inputText.trim()) return;
          const downloadGif = (
            <img className="download-gif" src="/images/loading-spinner.gif" />
          );
          setChatMessages((prev) => [
            ...prev,
            {
              message: inputText,
              sender: "user",
              id: crypto.randomUUID(),
            },
            {
              message: downloadGif,
              sender: "robot",
              id: crypto.randomUUID(),
            },
          ]);
          setInputText("");
          setIsLoading(true);
          try {
            const response = await Chatbot.getResponseAsync(inputText);
            setChatMessages((prev) => {
              const withoutLoading = prev.filter(
                (msg) => msg.message !== downloadGif
              );
              return [
                ...withoutLoading,
                {
                  message: response,
                  sender: "robot",
                  id: crypto.randomUUID(),
                },
              ];
            });
          } catch (error) {
            console.log(error);
            console.log("Something went wrong! Please try again later");
          } finally {
            setIsLoading(false);
          }
        }
        function handleKeyDown(event) {
          const key = event.key;
          if (key === "Enter") {
            sendMessage();
          } else if (key === "Escape") {
            setInputText("");
          }
        }
        return (
          <>
            <input
              placeholder="Send a message to Chatbot"
              size="30"
              onChange={saveInputText}
              onKeyDown={handleKeyDown}
              value={inputText}
              disabled={isLoading ? true : false}
              className="chat-input"
            />
            <button onClick={sendMessage} className="send-button">
              Send
            </button>
          </>
        );
      }
      function ChatMessage({ sender, message }) {
        return (
          <>
            {sender === "robot" && (
              <img src="./images/robot.png" className="avatar" />
            )}
            <div className="message">{message}</div>
            {sender === "user" && (
              <img src="./images/user.png" className="avatar" />
            )}
          </>
        );
      }
      function useAutoScroll(dependencies) {
        //кастомный хук для скролаа
        const elementRef = React.useRef(null);
        React.useEffect(() => {
          elementRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [dependencies]);
        return elementRef;
      }
      function ChatMessages({ chatMessages }) {
        const messagesEndRef = useAutoScroll(chatMessages);
        return (
          <>
            {chatMessages.map((chatMessage) => {
              return (
                <div
                  key={chatMessage.id}
                  className={
                    chatMessage.sender === "user"
                      ? "chat-message-user "
                      : "chat-message-robot"
                  }
                >
                  <ChatMessage
                    message={chatMessage.message}
                    sender={chatMessage.sender}
                  />
                </div>
              );
            })}
            <div ref={messagesEndRef}></div>
          </>
        );
      }
      function App() {
        const [chatMessages, setChatMessages] = React.useState([]);
        const [chatInputPosition, setChatInputPosition] = React.useState("top");
        function changeChatInputPosition(event) {
          const swithcerText = event.target.innerText;
          if (swithcerText === "Move textbox to bottom") {
            setChatInputPosition("bottom");
          } else if (swithcerText === "Move textbox to top") {
            setChatInputPosition("top");
          }
        }
        return (
          <div className="js-container">
            <div
              className={
                chatInputPosition === "bottom"
                  ? "chatbot-container chatbot-container-bottom"
                  : "chatbot-container chatbot-container-top"
              }
            >
              <div className="position-switcher-container">
                <a
                  onClick={changeChatInputPosition}
                  className="position-switcher"
                >
                  {chatInputPosition === "top"
                    ? "Move textbox to bottom"
                    : "Move textbox to top"}
                </a>
              </div>

              {chatInputPosition === "top" && (
                <div className="chat-input-container">
                  <ChatInput
                    setChatMessages={setChatMessages}
                    chatMessages={chatMessages}
                  />
                </div>
              )}
              {chatMessages.length === 0 && (
                <p className="welcome-message">
                  Welcome to the chatbot project! Send a message using the
                  textbox {chatInputPosition === "top" ? "above." : "below."}
                </p>
              )}
              <div className="chat-messages-container">
                <ChatMessages chatMessages={chatMessages} />
              </div>
              {chatInputPosition === "bottom" && (
                <div className="chat-input-container">
                  <ChatInput
                    setChatMessages={setChatMessages}
                    chatMessages={chatMessages}
                  />
                </div>
              )}
            </div>
          </div>
        );
      }
      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
